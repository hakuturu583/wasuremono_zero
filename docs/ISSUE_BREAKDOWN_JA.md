# Issue分解（依存関係つき）

このドキュメントは、`docs/IMPLEMENTATION_PLAN.md` の実装ステップを実行可能なIssueに分解したものです。
各Issueは「完了条件（DoD）」と「依存Issue」を明記しています。

## マイルストーン
- **M1: 開発基盤の確立**（#1, #2）
- **M2: コア機能実装**（#3, #4, #5, #6）
- **M3: ユーザー体験/品質向上**（#7, #8, #9, #10, #11）
- **M4: リリース準備**（#12）

---

## Issue一覧

### #1 CI: GitHub ActionsでiOSビルド検証を追加する
**目的**
- Push/PR時に `WasuremonoZero` がクリーンビルドできることを自動検証する。

**作業内容**
- `.github/workflows/ios-build.yml` を作成。
- `macos-14` + Xcode 15系で `xcodebuild` 実行。
- Buildログのアーティファクト保存を設定。

**DoD**
- ワークフローがPush/PRで起動し、Debugビルドが成功する。
- 失敗時にログをダウンロードできる。

**依存Issue**
- なし

---

### #2 プロジェクト雛形: iOS 15+ / Swiftで基本構成を整備する
**目的**
- 実装を進めるための最小アプリ構成を整える。

**作業内容**
- ターゲット/スキーム `WasuremonoZero` の整合性確認。
- `Info.plist` に位置情報利用文言・Background Modes（location）を追加。
- 最小画面とアプリエントリを安定化。

**DoD**
- ローカルでDebugビルドが通る。
- 必須の `Info.plist` キーが設定済み。

**依存Issue**
- #1（推奨。CI上での継続検証のため）

---

### #3 通知基盤: カテゴリ/アクション定義と権限要求を実装する
**目的**
- 通知アクション（け/さ/キ/め/後で）をOSへ登録し、通知許可を取得する。

**作業内容**
- `NotificationService` を実装。
- カテゴリID `CHECK_ITEMS` と各アクションIDを定義。
- 初期化時のカテゴリ登録・権限要求フローを追加。

**DoD**
- 通知カテゴリが登録され、通知にアクションボタンが表示される。
- 許可状態に応じた処理分岐が確認できる。

**依存Issue**
- #2

---

### #4 位置検知基盤: SLC/Visit監視レイヤを実装する
**目的**
- バッテリー効率を保ちながら移動イベントを取得できる状態を作る。

**作業内容**
- `LocationService` を実装。
- `startMonitoringSignificantLocationChanges()` と `didVisit` の受信実装。
- 位置情報権限状態の管理APIを整備。

**DoD**
- 位置イベント受信時にコールバック/イベント通知が発火する。
- バックグラウンドでの起動シナリオを考慮した実装になっている。

**依存Issue**
- #2

---

### #5 トリガー連携: 移動検知からローカル通知発火までを接続する
**目的**
- 「移動を検知したら通知する」最短の縦断フローを成立させる。

**作業内容**
- Appライフサイクル層で `LocationService` と `NotificationService` を接続。
- 移動イベント受信時に通知作成/スケジュールを実行。
- 最低限のログ/計測ポイントを追加。

**DoD**
- 実機で移動イベント後に通知が届く。
- 通知アクション押下がアプリ状態へ伝播する。

**依存Issue**
- #3
- #4

---

### #6 判定ロジック: レート制限・サプレッションを実装する
**目的**
- 通知過多を防ぎ、同一場所/短時間連続の通知を抑制する。

**作業内容**
- `MovementPolicy` を実装。
- 最短通知間隔（例: 30分）と最小移動距離（例: 200m）を判定。
- 同一場所判定（座標丸め等）を導入。

**DoD**
- ポリシー判定のユニットテストが通る。
- 実機挙動で短時間連打通知が抑制される。

**依存Issue**
- #4
- #5

---

### #7 オンボーディング: 権限説明と段階的許可導線を実装する
**目的**
- 通知/位置情報の許可理由を明示し、許可率と審査適合性を高める。

**作業内容**
- 目的説明画面を追加。
- 通知許可→位置情報許可（必要に応じて段階的）を案内。
- 拒否時の再案内/設定遷移導線を用意。

**DoD**
- 初回起動時に一連の導線が破綻なく動作する。
- 審査説明として合理的な文言が用意されている。

**依存Issue**
- #3
- #4

---

### #8 設定画面: 対象項目・通知頻度・距離しきい値を編集可能にする
**目的**
- ユーザーが通知挙動を調整できるUIを提供する。

**作業内容**
- 対象項目（け/さ/キ/め）のオンオフUIを実装。
- 最短通知間隔/最小距離/スヌーズ等の設定UIを追加。
- バリデーションと初期値表示を整備。

**DoD**
- 設定変更がアプリ再起動後も保持される（#9と連携）。
- 設定値が通知判定に反映される（#6と連携）。

**依存Issue**
- #6
- #9（相互に関連、実装順は #8 → #9 でも可）

---

### #9 永続化: Settings/StateをUserDefaultsへ保存する
**目的**
- 設定値と直近状態（最終通知時刻など）を継続利用可能にする。

**作業内容**
- `Settings` / `State` の保存・読込レイヤを実装。
- 互換性を考慮したキー設計とデフォルト値を定義。
- 主要状態更新ポイント（通知発火時、アクション押下時）で保存。

**DoD**
- 再起動後に設定/状態が復元される。
- 不正値/欠損値でもクラッシュしない。

**依存Issue**
- #5

---

### #10 テスト整備: Policy/Notification/UIの自動テストを追加する
**目的**
- 回帰防止のため、重要ロジックを自動テストで担保する。

**作業内容**
- `MovementPolicy` の時間/距離しきい値テストを追加。
- 通知カテゴリ/アクションIDの登録テストを追加。
- 設定画面の最小UIテスト（またはスナップショット）を追加。

**DoD**
- CIでテストが安定実行できる。
- 主要分岐がテストでカバーされる。

**依存Issue**
- #3
- #6
- #8

---

### #11 文言・ローカライズ・アイコン整備
**目的**
- 日本語UXを磨き、通知や画面文言の一貫性を確保する。

**作業内容**
- 主要画面/通知文言を日本語で統一。
- 必要に応じてローカライズ基盤（`Localizable.strings`）を導入。
- アプリアイコン/必要アセットを整備。

**DoD**
- 主要導線の文言が日本語で自然。
- 通知文言とアクション名称が仕様と一致。

**依存Issue**
- #7
- #8

---

### #12 リリース準備: TestFlight配布と審査向け情報整理
**目的**
- 外部テストとストア審査に必要な準備を完了する。

**作業内容**
- TestFlight配布フロー（ビルド番号運用含む）を確立。
- 審査メモ（常時位置許可の必要性説明）を作成。
- 既知制限・問い合わせ導線を整理。

**DoD**
- TestFlightでインストール～基本導線確認ができる。
- 審査提出に必要な説明文が揃っている。

**依存Issue**
- #10
- #11

---

## 依存関係サマリ（DAG）
```text
#1 → #2
#2 → #3, #4
#3 & #4 → #5
#4 & #5 → #6
#3 & #4 → #7
#5 → #9
#6 & #9 → #8
#3 & #6 & #8 → #10
#7 & #8 → #11
#10 & #11 → #12
```

## 並行実行の推奨
- **同時着手しやすい組み合わせ**
  - #3（通知基盤）と #4（位置検知基盤）
  - #7（オンボーディング）と #9（永続化）
- **競合しやすい領域**
  - Appエントリポイント/DI配線（#5, #7, #8）
  - しきい値仕様（#6）と設定UI（#8）の項目定義

## Issue起票テンプレート（コピー用）
```md
## 背景

## 目的

## 作業内容
- [ ] 
- [ ] 

## 完了条件（DoD）
- [ ] 
- [ ] 

## 依存Issue
- #

## 備考
```

## GitHub Issue自動起票スクリプト
- スクリプト: `scripts/create_github_issues.py`
- 使い方（実作成）:
  - `export GITHUB_REPO=owner/repo`
  - `export GITHUB_TOKEN=ghp_xxx`（または `GH_TOKEN` / `SECRT` / `SECRET`）
  - `python scripts/create_github_issues.py --create`
- 使い方（確認のみ）:
  - `python scripts/create_github_issues.py --repo owner/repo --dry-run`
